#!/usr/bin/env bash
set -eu


function has(){
    type "$1" > /dev/null 2>&1
}

function symlink(){
    if [ -L "$2" ]; then
        unlink "$2"
    else
        if [ -e "$2" ]; then
            mv "$2" "$2.bak"
            echo "$2.bak created"
        fi
    fi
    echo "linking $1 => $2" >&2
    ln -s "$1" "$2"
}

function link(){
    dotfiles=$HOME/dotfiles

    has vim && symlink "$dotfiles/vimrc" "$HOME/.vimrc"
    has git && symlink "$dotfiles/gitconfig" "$HOME/.gitconfig"
    has tmux && symlink "$dotfiles/tmux.conf" "$HOME/.tmux.conf"
    has fish && symlink "$dotfiles/fish-conf" "$HOME/.config/fish"
    has zsh && symlink "$dotfiles/zshrc" "$HOME/.zshrc"
    has zsh && symlink "$dotfiles/zshenv" "$HOME/.zshenv"
    [ -d $HOME/.config/gh  ] || mkdir -p $HOME/.config/gh
    has gh && symlink "$dotfiles/gh/config.yml" "$HOME/.config/gh/config.yml"
    symlink "$dotfiles/bashrc" "$HOME/.bashrc"
    [ -d $HOME/.vim  ] || mkdir $HOME/.vim
    symlink "$dotfiles/vim/config" "$HOME/.vim/config"
    symlink "$dotfiles/vim/coc-settings.json" "$HOME/.vim/coc-settings.json"
    symlink "$dotfiles/.alacritty.yml" "$HOME/.alacritty.yml"

    dotfiles_private=$HOME/dotfiles_private
    if [ -e $dotfiles_private ]; then
        symlink "$dotfiles_private/ssh-config" "$HOME/.ssh/config"
    fi
}

function copy(){
    dotfiles=$HOME/dotfiles

    cp "$dotfiles/.vimrc" "$HOME/.vimrc"
    cp "$dotfiles/.bashrc" "$HOME/.bashrc"
}

function pull(){
    dotfiles=$HOME/dotfiles
    cd "$dotfiles"
    CID0=`git log --pretty=format:"%H" | head -n 1`
    CID1=`git ls-remote origin HEAD | awk '{print $1}'`
    if [ "$CID0" != "$CID1" ]; then
        echo "remote change found"
        echo "pulling changes..."
        git pull origin master
        echo "pulled"
        git diff --stat "$CID0".."$CID1"
    fi

    dotfiles_private=$HOME/dotfiles_private
    if [ -e $dotfiles_private ]; then
        cd "$dotfiles_private"
        CID0=`git log --pretty=format:"%H" | head -n 1`
        CID1=`git ls-remote origin HEAD | awk '{print $1}'`
        if [ "$CID0" != "$CID1" ]; then
            echo "remote change found"
            echo "pulling changes..."
            git pull
            echo "pulled"
            git diff --stat "$CID0".."$CID1"
        fi
    fi
}

function push(){
    dotfiles=$HOME/dotfiles
    cd "$dotfiles"
    msg=`git status -s | sed -e "s/^ //" -e "s/ /_/g"` || :
    git add .
    if git commit -m "$msg" > /dev/null 2>&1 ; then
        echo "local change found"
        git diff --stat HEAD^ HEAD
        echo "pushing changes..."
        git push origin master
        echo "pushed to remote"
    fi

    dotfiles_private=$HOME/dotfiles_private
    if [ -e $dotfiles_private ]; then
        cd "$dotfiles_private"
        msg=`git status -s | sed -e "s/^ //" -e "s/ /_/g"` || :
        git add .
        if git commit -m "$msg" > /dev/null 2>&1 ; then
            echo "local change found"
            git diff --stat HEAD^ HEAD
            echo "pushing changes... (private)"
            git push origin main
            echo "pushed to remote"
        fi
    fi
}

function sync(){
    pull 
    push
    link
}

function vi(){
    dotfiles=$HOME/dotfiles
    exec vi "$dotfiles"
}

function code(){
    dotfiles=$HOME/dotfiles
    exec code "$dotfiles"
}

function installPlug() {
    curl -fLo ~/.vim/autoload/plug.vim --create-dirs \
        https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
}

function help() {
        echo "usage: dotfiles [<command>]


dotfiles commands

help            - show this help
pull            - pull from remote repository
push            - push to remote repository
sync            - pull / push repote repository
link            - create symlink (ask)
vi              - edit dotfiles directory in vim
code            - edit dotfiles directory in VSCode
install-plug    - install vim-plug to vim 
" 1>&2
        exit 1
}

if [ $# == 0 ]; then
    echo "no subcommand given. running \`dot sync\` ..."
    sync
    exit
fi

subcommand="$1"
shift

case $subcommand in
    pull)
        pull
        ;;
    push)
        push
        ;;
    sync)
        sync
        ;;
    copy)
        copy
        ;;
    link)
        link
        ;;
    vi)
        vi
        ;;
    code)
        code
        ;;
    install-plug)
        installPlug
        ;;
    cron)
        sync >/dev/null 2>&1
        ;;
    *)
        help
        ;;
esac
